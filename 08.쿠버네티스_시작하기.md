# 쿠버네티스 시작하기

## 레플리카셋(Replica Set) : 일정 개수의 포드를 유지하는 컨트롤러
앞서 쿠버네티스의 기본 단위인 pod에 대해 살펴보았는데, pod가 종료되는 경우 어떻게 될까?  
일단 pod를 종료시키는 방법에 대해서 알아보자.  
```bash
kubectl delete -f nginx-pod-with-ubuntu.yaml
kubectl delete pods  my-nginx-pod
```
위와 같은 명령어를 사용하면 pod가 종료되는데, 서비스에서 pod를 사용하는 경우 외부 요인에 의해 pod가 종료되지 않도록 하는 것이 중요하다.  
이를 Replica Set을 이용해 구성하는 것이 가능하며 Replica Set는 아래와 같은 특징을 가진다.
- 정해진 수의 동일한 포드가 항상 실행되도록 관리
- 노드 장애 등의 이유로 포드를 실행할 수 없다면 다른 노드에서 포드를 다시 생성
Replica Set를 사용하면 동일한 Nginx pod를 안정적으로 여러 개 운영하는 것이 가능하며, 노드에 장애가 발생하는 경우에도 정해진 개수의 pod를 자동으로 유지해준다.

### Replica Set 사용하기
```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: replicaset-nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-nginx-pods-label
  template:
    metadata:
      name: my-nginx-pod
      labels: 
        app: my-nginx-pods-label
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
```
yaml 파일의 내용중 spec.template를 기준으로 위쪽은 Replica Set에 대한 정의를 나타내며 아래쪽은 pod에 대한 정의를 나타낸다.  
spec.replicas에 정의된 값으로 pod가 유지될 갯수를 정의하게 된다.  

### Replica Set의 동작 원리
Replica Set을 생성하면 pod가 생성되고, Replica Set을 삭제하면 pod가 삭제되어 서로 연결된 것처럼 보이지만 실제로는 그렇지 않다.  
Replica Set과 pod는 metadata에 존재하는 label selector을 사용해 연결되는데, yaml 파일에서의 spec.selector.matchLabels.app와 spec.template.metadata.labels.app의 값으로 Replica Set과 pod가 연결된다.  
Replica Set은 spec.selector.matchLabels.app에 존재하는 값과 동일한 label을 가진 pod의 갯수를 지정한 replicas 수 만큼 유지하는 것을 목적으로 한다.  
그렇다면 같은 label을 가지는 pod가 기존에 생성되어 있는 경우는 어떻게 될까?  
Replica Set은 이 조차도 하나의 pods로 판단하여 replicas에 포함시키며, 새로 생성되는 pod는 2개가 된다.  
[313p]  
반대로 수동으로 생성된 pod를 생성하면 Replica Set은 pod를 3개 유지하기 위해 pod를 신규로 생성하여 3개의 pod를 유지한다.  

이번에는 Replica Set에 있는 spec.template.metadata.labels.app를 제거해보자.  
pod의 label이 제거되는 경우 Replica Set은 label이 없는 pod는 관리대상으로 취급하지 않게 되어 Replica Set을 제거해도 해당 pod는 삭제되지 않고 남아있게 된다.  
이를 통해 Replica Set의 목적이 무엇인지 생각해 볼 수 있는데, Replica Set의 목적은 pod의 생성이 아닌 일정한 갯수의 pod를 관리하기 위한 용도로 사용된다고 생각할 수 있다.  

### Replication Controller vs Replica Set
Replication Controller은 이전 k8s의 버전에서 사용되었단 Replica Set의 이전 버전이라고 생각하면 되며, 현재는 deprecated되어 더 이상 사용되지 않는다.  

# Deployment : Replica Set, pod의 배포 관리
